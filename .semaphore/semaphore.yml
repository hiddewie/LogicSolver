version: v1.0
name: Build and test pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Build and tests"
    task:
      secrets:
        - name: cc
      jobs:
        - name: Build and tests
          commands:
            - checkout
            - curl -LsS https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
            - chmod +x ./cc-test-reporter
            - ./cc-test-reporter before-build

##  - name: "Build and test"
##    task:
##      jobs:
#        - name: Build and test
#          commands:
#            - checkout
            - ./gradlew build jacocoTestReport --console=plain

#  - name: "Upload coverage"
#    task:
#      jobs:
#        - name: Code Climate test reporter
#          commands:
#            - checkout
            - cd logicsolver/src/main/kotlin
            - ./../../../../cc-test-reporter format-coverage ../../../build/reports/jacoco/test/jacocoTestReport.xml --input-type jacoco --output ../../../../coverage/codeclimate.json
            - cd ../../../..
            - ./cc-test-reporter upload-coverage
